name: k8s-bootstrap
on:
  workflow_dispatch:

jobs:
  k8s-bootstrap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true

      - name: Set AKS context
        uses: azure/aks-set-context@v3
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          resource-group: ${{ secrets.AZURE_BACKEND_RG }}
          cluster-name: "aks-staging-lab001"

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'stable'

      - name: Install helm
        uses: azure/setup-helm@v4.3.0
        with:
          version: latest

      - name: Create namespaces
        run: |
          kubectl apply -f k8s/namespaces/namespace-bootstrap.yaml

      - name: Install cert-manager CRDs
        run: |
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/latest/download/cert-manager.crds.yaml

      - name: Install cert-manager
        run: |
          helm repo add jetstack https://charts.jetstack.io
          helm repo update
          helm upgrade --install cert-manager jetstack/cert-manager \
            --namespace cert-manager --create-namespace \
            --set installCRDs=false --wait

      - name: Install ingress-nginx
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update
          helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
            --namespace ingress-nginx -f k8s/helm-values/ingress-values.yaml --wait

      - name: Install metrics-server
        run: |
          helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
          helm repo update
          helm upgrade --install metrics-server metrics-server/metrics-server \
            --namespace kube-system --set args="{--kubelet-insecure-tls,--kubelet-preferred-address-types=InternalIP}" --wait

      - name: Install kube-prometheus-stack
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
          helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
            --namespace monitoring -f k8s/helm-values/prometheus-values.yaml --wait
